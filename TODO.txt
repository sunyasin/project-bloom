Supabase last migration applied 15/01/26 
E:\work\project-bloom\supabase\migrations\20260115173551_ba8551d5-457a-4925-a2c6-6c7c2f32112d.sql
(-- Add sum column for coin exchanges)

TODO 

---after BIG update issues:

2 popup окна после коика на товаре в категории
убрать глаз из dashboard - теперь есть модератор


----- РУКАМИ

если визитка одна, не показывать блок визиток на странице производителя
- при регистрации нового юзера: подставлять email в форму 

- в списке категорий При фильтрации по городу пересчитываем производителей
- рассылки по email (после добавления новостей общих и в бизнесах)
- обмен товарами и товар-цифра - добавить лого товара


- модерация - отправлять сообщение с типом moderator
- модерация: если выбрано radio "доработать", то отправка меняет статус визитки на rejected (добавь)
----- РУКАМИ
для страницы админки /admin - анализируй user_roles. Сделай так чтобы Для роли superadmin были доступны все пункты слева. Для news_moderator - только Новости. Для moderator - только раздел заявки. не трогай остальной проект.


- в админку добавить регистрацию доната за акции  - запись числа в promotions.donate



- на странице бизнеса реализовать:

- сообщения - кол-во непрочитанных в каждом разделе


--- ERRORS
- картинка визитки и товара не подгружается на карточке бизнеса.
 - фильтра по городам в категориях не работает

--- ERRORS

=====  ошибки RLS  
 
Customer Contact Information Exposed to All Users	
PUBLIC_USER_DATA
LLM Database Check
The 'profiles' table is readable by all authenticated users and contains sensitive personal data including email addresses, phone numbers, GPS coordinates, home addresses, and wallet balances. Any logged-in user can access every other user's contact details, location, and financial information. This could enable harassment, stalking, identity theft, or targeted scams. Restrict the SELECT policy to only allow users to view their own profile data (auth.uid() = user_id) and remove the 'Authenticated users can view all profiles' policy.
=====  ошибки RLS  
 
 
 
-----LATER 
- push уведомления о заказе
- для акций добавить расчет стоимости доната чтобы быть в топ 5, топ 10 акций. 


===== ???? нужно? 
- на станице списка произвоителей: вверху список ссылок (названия городов) ниже якори Город и под ним производители из города.
- при бартере нужна торговля, другая цена?
- Добавь realtime-уведомления о новых запросах на обмен через Supabase Realtime
- перевести с UUID на автоинкремент
- подписка на новости одной категории ? а нада?

редактор товара - при выборе "бартер цифровой" отображай (или делай редактируемым) числовое поле (проверяй что введено число в поле) - с Label "Эквивалент цены"  
===== ?????



====== DONE
webhook https://api.telegram.org/bot8463475565:AAHc6vvKxuV55DF-qlqbvIRRp5He-rqu-HM/setWebhook?url=https://njrhaqycomfsluefnkec.supabase.co/functions/v1/get-telegram-id


- обмен товар-товар - добавлять запись в exchange (просить после обмена отметить done) для товарных - "Запросы на обмен(Х)" - список обменов возле каждого можно написать (иконка чата) и галка done или reject(delete).

- обмен товар-коин -  добавлять запись в exchange, - в dashboard отображать "Запросы на обмен(Х)" - список обменов.  кнопка "Оплатить"(для покупателя - он оплачивает только после получения товара), а для продавца - только меняет статус. (торговля, другая цена?)

- Добавь RLS политики для таблиц coins и exchange, чтобы устранить предупреждения безопасности
- в админке - можно несколько ролей назначить одному юзерю
на странице бизнеса реализовать: 1) добавить адрес доставки при заказе
- на /dashboard - в плашке с именем пользователя отображай реальную роль из таблицы user_roles, на английском как в ENUM
- после успешной отправки денег обновить wallet получателя.
- клик на товаре на карточке бизнеса - popup с полной инфо

- кнопка Связаться на карточке бизнеса - popup с чатом
- tiptap не епчатает пробелы - заменен на Qill.js
- для цифрового бартера добавить поле цены
- реальная  подписки на новости на главной и на странице бизнеса (без отсылки email) 
3) Mock subscribe API - реальная подписка на карточке бизнеса
=======DONE






======= форма БАРТЕРОНА 
(тест) рядом с кнопкой купить - кнопка бартер. 
окно бартера:
	- выбранные товары продавеца
	- юзер выбирает свои товары (из профиля для бартера) или выбирает коины с кошелька (если продавец продаёт за коины все выбранные товары).
нажимает кнопку "создать обмен" -> отправляет продавцу оповещение.
продавец смотрит, отвечает - видит форму что на что меняется. 
На форме кнопки Одобрить, отклонить и чат (из записей таблицы между двумя(дублируется в сообщения профиля).

1) одобрить + товар_на_товар - сами договариваются

2) одобрить+коины (=встреча) - 
на встрече: 
(СЛОЖНЕЕ) 
система генерит QR код(хэш) сделки для списания (ввод кода сделки в форму) и отсылает код покупателю.
покупатель с кодом получает товар и дает продавцу код, продавец вводит код в форму сделки и так запускает транзакцию и этим подтверждает передачу товара.

либо (=== ЭТО ПРОЩЕ === ) продавец показывает код своего кошелька(отсылает в чате) и покупатель переводит при встрече коины из формы в профиле (нужен инет), продавец видит коины и отдаёт товар.

транзакция: 
	- запись в таблице сделок:  списать Х у покупателя	
	- запись в таблице сделок: зачислить Х продавцу.
	
ОБМеНКА :
товар - рубли 
форма сумма рубли = сумма коины 
"создать обмен" - отсылка в телегу чат. там перевод, проверка и зачисление.
Зачисление:
	- запись в таблицу коинов: хэш предыдущий+ID коина = хэш нового коина (id, баланс и хэш в разных столбцах).
	хэш декодируемый в пару: хэш+ID (для проверки равенства значений в полях) 
	
	
	
	
======================================================
портал произвоздителей товаров и услуг
=======================================================
 - портал для резидентов(производителей товаров-услуг) и посетителей региона (покупателей). Бизнесы производителей распределены по категориям. 
 1) Портал помогает посетителю  просматривать лэндинги(визитные карточки) производителей товаров-услуг, и список товаров и услуг каждого производителя. 
 2) Смотреть акции, общие новости региона и новости производителей по категориям и подписываться на email-рассылку новостей.  
 3) Использовать биржу бартерного обмена товаров "бартерон" товар-товар или товар-коины.(пока без реализации, заглушка)
 4) для производителей в личном кабинете можно формировать в WISIWIG-редакторе страницы-визитку на своих бизнесов в разных категориях. И для выбранной категории для визитки создавать карточки товаров (загружать картинку+текст+цена+акция). Помечать товары для бартера (назначать эквивалент цены в коинах)


Роли в UI
 Посетитель.
	- смотрит новости
	- ищет поставщика услуги/товара
	- подписывается на новости/события/акции в категории или все
	- использует бартерон (аналог. ДОЛИНАКОИН)
	
 Клиент	
	1) регистрируется с email, входит по логин-паролю. 
	2) Создаёт, редактирует, скрывает-показывает, удаляет карточки презентации бизнеса
	3) создаёт, редактирует, скрывает-показывает, удаляет карточки товаров
	4) помечает товары на бартерон (бартер только товар-товар или за цену в коинах)
	5) Просматривает и отвечает на личные сообщения от посетителей и других участников (запросы бартера).
 
Роли в UI-админке:
супер-админ, клиент, редактор новостей, модератор

Вид страниц:
1) главная - слева разделы(дерево. после клика слева открывается контент активного раздела):
	- акции
	- события месяц-неделя
	- новости долины
	- новости категорий
	- бартерон (скрыто, будет отдельный модуль)
	- и далее-список категорий (после названия в скобках кол-во клиентов в этой категории).
Справа - блок акций.
Акции клиентов - на главной (матрица блоков по 3 в строке (картинка акции)). Сортировка по убыванию суммы оплат за последние 30 дней. 


Новости - новости долины общие + новости резидентов из всех категорий с combobox-фильтром по категориям 

Календарь событий - (резиденты обновляют график сами) + кнопка подписки по email на новости/события



Посетитель Выбрает категорию в дереве слева - 
справа - контент категории: матрица (регулируется размерность кнопкой настройки) из блоков "название на фоне логотипа". Над матрицей строка кнопок : сортировка, поиск, фильтр, переключатель вида. 
начальная сортировка - по свежести редактуры, по убыванию суммы доната за 30 дней. 

клик по лого/названию бизнеса -> открывается карточка бизнеса

2)страница карточки бизнеса:
	лэндинг-Презентация  бизнеса
	под лэндингом - созданные карточки Товаров для этого бизнеса (матрица блоков-картинок по 3 в строке - кол-во 3-4-5 в строке переключается нажатием кнопки )

	Над матрицей: 1) ссылки на другие бизнесы резидента
	2) иконка для popup-формы обратной связи - задать вопрос, указав свой email для ответа.
	3) иконка подписки на новости этого производителя.

	Под матрицей - другие похожие бизнесы (из той же категории с сортировкой по убыванию суммы донатов за последний месяц).
	
3) Админка:
роли: супер-админ, клиент , редактор новостей долины, модератор 

Роль "клиент".

а) логин-логаут с восстановлением пароля.
б) после входа видит плитки своих визиток, по клику - видит превью готовой страницы этой визитки со списком товаров. По клику на кнопке "Редактировать визитку" переход в редактор визитки. По клику на товаре - в "редактор товаров".
в редакторе визитки: 
	 формирует лэндинг (TipTop WISIWIG с перетаскиванием и удалением блоков) 
в редакторе товаров:
	 формирует карточки товаров (картинка + текст + цены)
в) создаёт событие в календаре (дата, время, загрузить картинку, описание)
г) видит список новостей, может удалить, редактировать, создать новость (WISIWIG-редактор без кнопок форматирования, только список эмодзи для вставки в текст) 
	
	

Роль супер-админ.
- видит и редактирует список категорий (может изменить категорию у клиентских визиток)
- редактор веток дерева (скрыть/добавить/удалить/переименовать/переместить) 
- окно с разными настройками портала (поле "контакты support", заглушка - редактор страниц помощи), 
- окно аналитики клиентов, оплаты (кто, сколько, дата, категория - с сортировкой по этим полям ),
- окно для настроек и аналитики по бартерону (пока заглушка - реализация позже)
- бухгалтерия коинов (пока заглушка) 

Роль "редактор новостей" - добавляет/удаляет/редактирует общие новости вне категорий.

Роль "модератор" - модерация акций, событий, новостей, карточек и категорий (чтобы на одном лендинге не было услуг из нескольких категорий).
На главной видит список  новые/отредактированные страницы со статусом "непроверенные" карточек и товаров.  Заходит на них превью. Может поменять категорию. Кнопкой вызывает popup с textarea для комментария и двумя кнопками - "исправить" и "проверено". (запоминается в БД кто нажал, дата, на какой странице, комментарий, если поменял категорию то с какой на какую).




Связанный Модуль "БАРТЕРОН" (пока заглушка)

ИДЕЯ: рынок товаров на обмен и продажу за внутренние коины.

К аккаунту пользователя портала привязан счет во внутренних коинах (у каждого коина свой уникальный хэш-строка).

Пользователь слева выбирает категорию товаров, помеченных для бартера и справа видит плитку карточек товара от всех поставщиков в этой категории (фильтры, сортировка, поиск по названию товара).
Выбрав товар - просмотр карточки товара. На карточке кнопка "начать бартер" - popup окно с параметрами обмена: наименование, цена от продавца, поле для ввода кол-ва. Кнопка Уведомить - отправляет запрос на email и в ЛК поставщику. 

кейс 1) 
производитель (ПР) выставил товар за товар и/или товар-коины. 
Контрагент (К) предлагает: 1) товар из бартерона 2) коины. 
ЗА рубли - лично.
 
1) товар-товар. ПР и К определили на бартероне Эквивалент в коинах. и производят обмен по количеству штук/объема услуг. "Сдача" - коины на счет или "без сдачи" (К соглашается во время подтверждения или после сделки).

2) товар - коины.
	если коинов нет - в обменник. 
	
		Обменник принимает рубли (касса- "публичная" прозрачная карта? выписка - ежедневно) выдаёт коины. (пока через чат в телеграме - меняющий должен сообщить свой ID кошелька в системе) 

		рубли обменника - обеспечение для обратного выкупа хранится отдельно.(инфляция?)

		КАЖДЫЙ если хочет, меняет коины на рубли обменника 1 к 1 - (коины становятся отрицательными с атрибутами обратного обмена: сумма обмена и сумма кассы до списания - сохраняется история всех обменов).
				
		Коины нельзя подделать и выпустить вне обмена.
		(ID - строка из всех атрибутов через разделитель_)
		строка атрибутов=ID коина: 
			дата+время миллисекунды обмена 
			сумма обмена(+/-)
			сумма в кассе на момент до обмена 
			ID менятеля.
		
		 1 коин = 1 рубль = 1 ID (хэш) - все коины  - в БД.
		 
		 баланс (отображать, проверяемо резидентами как ? - публиковать выписки и все обмены каждый день) 
		 всегда кол-во коинов = кол-во рублей в кассе.
		 
		
	если коины есть, то 
	0) создается запись сделки с Х коинов и всеми атрибутами
	2)  у покупателя в ЛК  висит QR-код сделки  (ссылка на API - счет списания, сумма)
	покупатель показывает продавцу QR в момент принятия товара и продавец иниициирует списание считывая qr своим приложением (и получает подтверждение, QR код проверяется и коины меняют хозяина.) 
	или 
	3) или покупатель в приложении или на сайте в ЛК - перечисляет на месте и показывает подтверждение продавцу) 
	
	ЕСЛИ бартер удаленно с отсылкой ???
	

ПРИЛОЖЕНИЕ.
показывает БАЛАНС,ТРАНЗАКЦИИ + QR (всегда виден и содержит номер счета этого кошелька)

можно создать QR для любой сделки в обе стороны 
продавец создает QR для списания на свой счет - покупатель считывает qr в том же приложении и списывает в счет продавца

либо

покупатель создает qr код со своим счетом и суммой и отсылает продавцу. 