Supabase last migration applied 12/01/26 (-- Drop and recreate exchange_type enum with new values)

TODO 
---after BIG update issues:
2 popup окна после коика на товаре в категории
убрать глаз из dashboard - теперь есть модератор
tiptap не епчатает пробелы
- для цифрового бартера добавить поле цены

----- РУКАМИ


- при регистрации нового юзера: подставлять email в форму 
- при регистрации нового юзера: unmock: const [orderPhone, setOrderPhone] = useState(mockAPIUserProfile.phone);
- после регистрации сообщать что отправлен email для подтверждения

- в списке категорий При фильтрации по городу пересчитываем производителей

----- РУКАМИ


- редактор товара - картинка товара - сделать карман и загрузку в blob вместо URL (поле URL убрать из редактора)

- Добавь RLS политики для таблиц coins и exchange, чтобы устранить предупреждения безопасности

- реальная  подписки на новости на главной и на странице бизнеса

--- коины
-добавить хэш-строку в таблицу, расчет следующего хэша на базе предыдущего
- проверять хэши и подсчитывать баланс по всем коинам и сверять с последней записью - пока только в админке, но нужно после каждой транзакции/обмена - с сообщением админу статуса проверки.

на странице бизнеса реализовать:
2)Mock order API - сохранять в таблицу exchange
3) Mock subscribe API - реальная подписка на карточке бизнеса

на станице произвоителей: вверху список ссылок (названия городов) ниже якори Город и под ним производители из города.

--- ERRORS
- картинка визитки и товара не подгружается на карточке бизнеса.
 - фильтра по городам в категориях не работает
 - глюки TipTap редактора - пробелы не печатаются, курсор странно себя ведет
 --- ERRORS

=====  ошибки RLS  
RLS Disabled in Public	
SUPA_rls_disabled_in_public
Supabase
Detects cases where row level security (RLS) has not been enabled on tables in schemas exposed to PostgREST Remediation: https://supabase.com/docs/guides/database/database-linter?lint=0013_rls_disabled_in_public 
 
Customer Contact Information Exposed to All Users	
PUBLIC_USER_DATA
LLM Database Check
The 'profiles' table is readable by all authenticated users and contains sensitive personal data including email addresses, phone numbers, GPS coordinates, home addresses, and wallet balances. Any logged-in user can access every other user's contact details, location, and financial information. This could enable harassment, stalking, identity theft, or targeted scams. Restrict the SELECT policy to only allow users to view their own profile data (auth.uid() = user_id) and remove the 'Authenticated users can view all profiles' policy.

Financial Transaction History Publicly Accessible	
MISSING_RLS_PROTECTION
LLM Database Check
The 'coins' table has RLS disabled entirely, making all coin transaction records publicly readable without authentication. This table contains user wallet balances, transaction amounts, and financial history. Hackers could analyze spending patterns, identify high-value targets, or exploit the system. Enable RLS on this table and create policies that restrict access to users' own transaction records only.

Warning
Leaked Password Protection Disabled	
SUPA_auth_leaked_password_protection
Supabase
Leaked password protection is currently disabled. Remediation: https://docs.lovable.dev/features/security#leaked-password-protection-disabled

Warning
Business Owner Identity Revealed in Public Listings	
EXPOSED_SENSITIVE_DATA
LLM Database Check
Published businesses expose the 'owner_id' field publicly, allowing anyone to map businesses to specific user accounts. Combined with the profiles table exposure, attackers could identify business owners' personal contact information and locations. This creates risks of targeted harassment, competitive intelligence gathering, or social engineering attacks. Modify the public SELECT policy to exclude the owner_id field or use a database view that filters sensitive columns.
 =====  ошибки RLS  
 
 
 
-----LATER 
- push уведомления о заказе
- для акций добавить расчет стоимости доната чтобы быть в топ 5, топ 10 акций. 


===== ???? нужно? 
- перевести с UUID на автоинкремент
- подписка на новости одной категории ? а нада?

редактор товара - при выборе "бартер цифровой" отображай (или делай редактируемым) числовое поле (проверяй что введено число в поле) - с Label "Эквивалент цены"  
===== ?????



====== DONE
на странице бизнеса реализовать: 1) добавить адрес доставки при заказе
- на /dashboard - в плашке с именем пользователя отображай реальную роль из таблицы user_roles, на английском как в ENUM
- после успешной отправки денег обновить wallet получателя.
- клик на товаре на карточке бизнеса - popup с полной инфо

- кнопка Связаться на карточке бизнеса - popup с чатом
=======DONE



====== проблема с пробелами в TipTap

Анализ проблемы
Проблема с пробелами в TipTap редакторе имеет несколько возможных причин:

1. Конфликт с cmdk (Command Menu)
Библиотека cmdk используется для выбора категории в Popover. Она известна тем, что перехватывает клавиатурные события, включая пробелы, когда открыта. Однако если Popover закрыт (categoryOpen = false), это не должно быть проблемой.

2. Отсутствие onMouseDown={(e) => e.preventDefault()} в BusinessCardEditor
В BusinessCardEditor.tsx (строки 63-84) компонент ToolbarButton не содержит onMouseDown={(e) => e.preventDefault()}, в то время как в ProductEditor.tsx (строки 97-108) он есть. Это может вызывать потерю фокуса при клике на кнопки тулбара.

3. Проблема с глобальными keyboard listeners
Возможно, где-то есть глобальный обработчик, который перехватывает пробелы.

Plan
План исправления проблемы с пробелами в TipTap
Проблема
Пробелы не вводятся в TipTap редакторе на странице редактирования товара.

Диагностика
В ProductEditor.tsx компонент ToolbarButton уже имеет onMouseDown={(e) => e.preventDefault()} — это правильно
В BusinessCardEditor.tsx этот обработчик отсутствует — нужно добавить для консистентности
Потенциальный конфликт с библиотекой cmdk (Command Menu), которая может перехватывать клавиатурные события
Решение
1. Добавить shouldFilter={false} и loop в Command компонент
В ProductEditor.tsx изменить компонент Command для выбора категории:


// Было:
<Command>
  <CommandInput placeholder="Поиск категории..." />

// Станет:
<Command shouldFilter={false} loop>
  <CommandInput 
    placeholder="Поиск категории..." 
    onKeyDown={(e) => {
      // Предотвращаем перехват пробелов и других клавиш
      if (e.key === " ") {
        e.stopPropagation();
      }
    }}
  />
2. Добавить onMouseDown в ToolbarButton в BusinessCardEditor.tsx

// Было (строка 74-83):
const ToolbarButton = ({ onClick, isActive, disabled, children }) => (
  <Button
    type="button"
    variant={isActive ? "secondary" : "ghost"}
    size="icon"
    className="h-8 w-8"
    onClick={onClick}
    disabled={disabled}
  >
    {children}
  </Button>
);

// Станет:
const ToolbarButton = ({ onClick, isActive, disabled, children }) => (
  <Button
    type="button"
    variant={isActive ? "secondary" : "ghost"}
    size="icon"
    className="h-8 w-8"
    onClick={onClick}
    onMouseDown={(e) => e.preventDefault()} // Предотвращает потерю фокуса
    disabled={disabled}
  >
    {children}
  </Button>
);
3. Убедиться, что Popover закрывается корректно
В обоих редакторах проверить, что после выбора категории Popover закрывается и не оставляет активных keyboard listeners.

Файлы для изменения
Файл	Изменения
src/pages/ProductEditor.tsx	Добавить обработчик onKeyDown в CommandInput для предотвращения перехвата пробелов
src/pages/BusinessCardEditor.tsx	Добавить onMouseDown={(e) => e.preventDefault()} в ToolbarButton
Результат
После этих изменений пробелы будут корректно вводиться в TipTap редакторе, а кнопки тулбара не будут вызывать потерю фокуса.








======= форма БАРТЕРОНА 
(тест) рядом с кнопкой купить - кнопка бартер. 
окно бартера:
	- выбранные товары продавеца
	- юзер выбирает свои товары (из профиля для бартера) или выбирает коины с кошелька (если продавец продаёт за коины все выбранные товары).
нажимает кнопку "создать обмен" -> отправляет продавцу оповещение.
продавец смотрит, отвечает - видит форму что на что меняется. 
На форме кнопки Одобрить, отклонить и чат (из записей таблицы между двумя(дублируется в сообщения профиля).

1) одобрить + товар_на_товар - сами договариваются

2) одобрить+коины (=встреча) - 
на встрече: 
(СЛОЖНЕЕ) 
система генерит QR код(хэш) сделки для списания (ввод кода сделки в форму) и отсылает код покупателю.
покупатель с кодом получает товар и дает продавцу код, продавец вводит код в форму сделки и так запускает транзакцию и этим подтверждает передачу товара.

либо (=== ЭТО ПРОЩЕ === ) продавец показывает код своего кошелька(отсылает в чате) и покупатель переводит при встрече коины из формы в профиле (нужен инет), продавец видит коины и отдаёт товар.

транзакция: 
	- запись в таблице сделок:  списать Х у покупателя	
	- запись в таблице сделок: зачислить Х продавцу.
	
ОБМеНКА :
товар - рубли 
форма сумма рубли = сумма коины 
"создать обмен" - отсылка в телегу чат. там перевод, проверка и зачисление.
Зачисление:
	- запись в таблицу коинов: хэш предыдущий+ID коина = хэш нового коина (id, баланс и хэш в разных столбцах).
	хэш декодируемый в пару: хэш+ID (для проверки равенства значений в полях) 
	
	
	
	
======================================================
портал произвоздителей товаров и услуг
=======================================================
 - портал для резидентов(производителей товаров-услуг) и посетителей региона (покупателей). Бизнесы производителей распределены по категориям. 
 1) Портал помогает посетителю  просматривать лэндинги(визитные карточки) производителей товаров-услуг, и список товаров и услуг каждого производителя. 
 2) Смотреть акции, общие новости региона и новости производителей по категориям и подписываться на email-рассылку новостей.  
 3) Использовать биржу бартерного обмена товаров "бартерон" товар-товар или товар-коины.(пока без реализации, заглушка)
 4) для производителей в личном кабинете можно формировать в WISIWIG-редакторе страницы-визитку на своих бизнесов в разных категориях. И для выбранной категории для визитки создавать карточки товаров (загружать картинку+текст+цена+акция). Помечать товары для бартера (назначать эквивалент цены в коинах)


Роли в UI
 Посетитель.
	- смотрит новости
	- ищет поставщика услуги/товара
	- подписывается на новости/события/акции в категории или все
	- использует бартерон (аналог. ДОЛИНАКОИН)
	
 Клиент	
	1) регистрируется с email, входит по логин-паролю. 
	2) Создаёт, редактирует, скрывает-показывает, удаляет карточки презентации бизнеса
	3) создаёт, редактирует, скрывает-показывает, удаляет карточки товаров
	4) помечает товары на бартерон (бартер только товар-товар или за цену в коинах)
	5) Просматривает и отвечает на личные сообщения от посетителей и других участников (запросы бартера).
 
Роли в UI-админке:
супер-админ, клиент, редактор новостей, модератор

Вид страниц:
1) главная - слева разделы(дерево. после клика слева открывается контент активного раздела):
	- акции
	- события месяц-неделя
	- новости долины
	- новости категорий
	- бартерон (скрыто, будет отдельный модуль)
	- и далее-список категорий (после названия в скобках кол-во клиентов в этой категории).
Справа - блок акций.
Акции клиентов - на главной (матрица блоков по 3 в строке (картинка акции)). Сортировка по убыванию суммы оплат за последние 30 дней. 


Новости - новости долины общие + новости резидентов из всех категорий с combobox-фильтром по категориям 

Календарь событий - (резиденты обновляют график сами) + кнопка подписки по email на новости/события



Посетитель Выбрает категорию в дереве слева - 
справа - контент категории: матрица (регулируется размерность кнопкой настройки) из блоков "название на фоне логотипа". Над матрицей строка кнопок : сортировка, поиск, фильтр, переключатель вида. 
начальная сортировка - по свежести редактуры, по убыванию суммы доната за 30 дней. 

клик по лого/названию бизнеса -> открывается карточка бизнеса

2)страница карточки бизнеса:
	лэндинг-Презентация  бизнеса
	под лэндингом - созданные карточки Товаров для этого бизнеса (матрица блоков-картинок по 3 в строке - кол-во 3-4-5 в строке переключается нажатием кнопки )

	Над матрицей: 1) ссылки на другие бизнесы резидента
	2) иконка для popup-формы обратной связи - задать вопрос, указав свой email для ответа.
	3) иконка подписки на новости этого производителя.

	Под матрицей - другие похожие бизнесы (из той же категории с сортировкой по убыванию суммы донатов за последний месяц).
	
3) Админка:
роли: супер-админ, клиент , редактор новостей долины, модератор 

Роль "клиент".

а) логин-логаут с восстановлением пароля.
б) после входа видит плитки своих визиток, по клику - видит превью готовой страницы этой визитки со списком товаров. По клику на кнопке "Редактировать визитку" переход в редактор визитки. По клику на товаре - в "редактор товаров".
в редакторе визитки: 
	 формирует лэндинг (TipTop WISIWIG с перетаскиванием и удалением блоков) 
в редакторе товаров:
	 формирует карточки товаров (картинка + текст + цены)
в) создаёт событие в календаре (дата, время, загрузить картинку, описание)
г) видит список новостей, может удалить, редактировать, создать новость (WISIWIG-редактор без кнопок форматирования, только список эмодзи для вставки в текст) 
	
	

Роль супер-админ.
- видит и редактирует список категорий (может изменить категорию у клиентских визиток)
- редактор веток дерева (скрыть/добавить/удалить/переименовать/переместить) 
- окно с разными настройками портала (поле "контакты support", заглушка - редактор страниц помощи), 
- окно аналитики клиентов, оплаты (кто, сколько, дата, категория - с сортировкой по этим полям ),
- окно для настроек и аналитики по бартерону (пока заглушка - реализация позже)
- бухгалтерия коинов (пока заглушка) 

Роль "редактор новостей" - добавляет/удаляет/редактирует общие новости вне категорий.

Роль "модератор" - модерация акций, событий, новостей, карточек и категорий (чтобы на одном лендинге не было услуг из нескольких категорий).
На главной видит список  новые/отредактированные страницы со статусом "непроверенные" карточек и товаров.  Заходит на них превью. Может поменять категорию. Кнопкой вызывает popup с textarea для комментария и двумя кнопками - "исправить" и "проверено". (запоминается в БД кто нажал, дата, на какой странице, комментарий, если поменял категорию то с какой на какую).




Связанный Модуль "БАРТЕРОН" (пока заглушка)

ИДЕЯ: рынок товаров на обмен и продажу за внутренние коины.

К аккаунту пользователя портала привязан счет во внутренних коинах (у каждого коина свой уникальный хэш-строка).

Пользователь слева выбирает категорию товаров, помеченных для бартера и справа видит плитку карточек товара от всех поставщиков в этой категории (фильтры, сортировка, поиск по названию товара).
Выбрав товар - просмотр карточки товара. На карточке кнопка "начать бартер" - popup окно с параметрами обмена: наименование, цена от продавца, поле для ввода кол-ва. Кнопка Уведомить - отправляет запрос на email и в ЛК поставщику. 

кейс 1) 
производитель (ПР) выставил товар за товар и/или товар-коины. 
Контрагент (К) предлагает: 1) товар из бартерона 2) коины. 
ЗА рубли - лично.
 
1) товар-товар. ПР и К определили на бартероне Эквивалент в коинах. и производят обмен по количеству штук/объема услуг. "Сдача" - коины на счет или "без сдачи" (К соглашается во время подтверждения или после сделки).

2) товар - коины.
	если коинов нет - в обменник. 
	
		Обменник принимает рубли (касса- "публичная" прозрачная карта? выписка - ежедневно) выдаёт коины. (пока через чат в телеграме - меняющий должен сообщить свой ID кошелька в системе) 

		рубли обменника - обеспечение для обратного выкупа хранится отдельно.(инфляция?)

		КАЖДЫЙ если хочет, меняет коины на рубли обменника 1 к 1 - (коины становятся отрицательными с атрибутами обратного обмена: сумма обмена и сумма кассы до списания - сохраняется история всех обменов).
				
		Коины нельзя подделать и выпустить вне обмена.
		(ID - строка из всех атрибутов через разделитель_)
		строка атрибутов=ID коина: 
			дата+время миллисекунды обмена 
			сумма обмена(+/-)
			сумма в кассе на момент до обмена 
			ID менятеля.
		
		 1 коин = 1 рубль = 1 ID (хэш) - все коины  - в БД.
		 
		 баланс (отображать, проверяемо резидентами как ? - публиковать выписки и все обмены каждый день) 
		 всегда кол-во коинов = кол-во рублей в кассе.
		 
		
	если коины есть, то 
	0) создается запись сделки с Х коинов и всеми атрибутами
	2)  у покупателя в ЛК  висит QR-код сделки  (ссылка на API - счет списания, сумма)
	покупатель показывает продавцу QR в момент принятия товара и продавец иниициирует списание считывая qr своим приложением (и получает подтверждение, QR код проверяется и коины меняют хозяина.) 
	или 
	3) или покупатель в приложении или на сайте в ЛК - перечисляет на месте и показывает подтверждение продавцу) 
	
	ЕСЛИ бартер удаленно с отсылкой ???
	

ПРИЛОЖЕНИЕ.
показывает БАЛАНС,ТРАНЗАКЦИИ + QR (всегда виден и содержит номер счета этого кошелька)

можно создать QR для любой сделки в обе стороны 
продавец создает QR для списания на свой счет - покупатель считывает qr в том же приложении и списывает в счет продавца

либо

покупатель создает qr код со своим счетом и суммой и отсылает продавцу. 